# Digital_pathology
# Классификация гистологических патчей (digital pathology)

Репозиторий содержит решение задания по классификации фрагментов гистологических
изображений (патчей) на 9 классов:

`ADI, BACK, DEB, LYM, MUC, MUS, NORM, STR, TUM`.

Каждый патч — цветное 8-битное изображение `224×224×3`.  
Основной файл решения: **`digitalpat.ipynb`**.

---

## Краткое описание метода

1. Используется исходный класс `Dataset` из задания для загрузки патчей и меток.
2. Для работы с PyTorch реализован адаптер `HistologyTorchDataset`,
   который:
   - берёт изображения из исходного `Dataset`,
   - применяет аугментации (флипы, повороты, ColorJitter) на обучении,
   - нормализует вход под предобученную ResNet-18 (стандартные mean/std ImageNet).

3. В качестве нейросетевой части вместо базовой небольшой CNN используется
   предобученный **ResNet-18** :
   - последний полносвязный слой заменён на `Identity`, поэтому backbone выдаёт
     512-мерный эмбеддинг;
   - поверх добавлен небольшой классификатор `Dropout + Linear(512 → 9)`.

4. По эмбеддингам ResNet-18 обучается классический метод машинного обучения —
   **RandomForestClassifier**.  
   Признаковое пространство: 512-мерные векторы, полученные из
   `forward_features(x)`.

5. Финальное предсказание строится как **ансамбль** нейросети и RandomForest:
   - `p_cnn` — softmax-вероятности от ResNet-18,
   - `p_rf` — вероятности классов от RandomForest,
   - итоговая вероятность: `p_final = 0.5 * p_cnn + 0.5 * p_rf`.

6. Реализована автоматическая загрузка весов обученной модели из облака:  
   метод `Model.load(base_path)` при отсутствии локальных файлов  
   `<base_path>_net.pth` / `<base_path>_rf.pkl` скачивает их с Google Drive через
   `gdown` по заранее заданным ID в словаре `CLOUD_CHECKPOINTS`.

7. В ноутбуке строится balanced accuracy по эпохам, а также выводятся основные метрики (`balanced accuracy`,
   матрица ошибок) на `train/val/test/test_tiny`.

---

## Результаты

В качестве основной метрики используется **balanced accuracy**, так как классы
в датасете несбалансированы.

```text
balanced accuracy (10% test)       ≈ 0.9889
balanced accuracy (test)      ≈ 0.9898
balanced accuracy (test_tiny) ≈ 0.9667
